name: Sync Docker Hub images â†’ GHCR

on:
  # schedule:
  #   - cron: "0 */6 * * *"  # Cháº¡y má»—i 6 tiáº¿ng
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Log in to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Define image list
        id: images
        run: |
          cat <<'EOF' > images.txt
          cloudflare/cloudflared:latest
          litestream/litestream:latest
          EOF
          echo "Defined images:"
          cat images.txt

      - name: Sync each image
        run: |
          while read -r line; do
            [ -z "$line" ] && continue
            IMAGE_SRC=$(echo "$line" | cut -d':' -f1)
            TAG=$(echo "$line" | cut -d':' -f2)
            NAME=$(basename "$IMAGE_SRC")
            IMAGE_DEST="ghcr.io/${{ github.repository_owner }}/$NAME"

            echo "------------------------------"
            echo "ðŸ” Checking: $IMAGE_SRC:$TAG â†’ $IMAGE_DEST:$TAG"
            echo "------------------------------"

            HUB_DIGEST=$(docker manifest inspect "$IMAGE_SRC:$TAG" --verbose | jq -r '.[0].Digest')
            echo "Docker Hub digest: $HUB_DIGEST"

            GHCR_DIGEST=$(docker manifest inspect "$IMAGE_DEST:$TAG" --verbose 2>/dev/null | jq -r '.[0].Digest' || echo "")

            if [ "$HUB_DIGEST" != "$GHCR_DIGEST" ]; then
              echo "ðŸ†• New version detected for $NAME â†’ syncing..."
              docker pull "$IMAGE_SRC:$TAG"
              docker tag "$IMAGE_SRC:$TAG" "$IMAGE_DEST:$TAG"
              docker push "$IMAGE_DEST:$TAG"
            else
              echo "âœ… $NAME is up to date."
            fi

            echo
          done < images.txt
