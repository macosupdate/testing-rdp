

name: proton

on:
  workflow_dispatch:
  repository_dispatch:
    types: [deploy-job]

concurrency:
  group: proton
  cancel-in-progress: false
  
jobs:
  testing-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600
    env:
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      TS_CLIENT_ID: ${{ secrets.QUY_TS_CLIENT_ID }}
      TS_CLIENT_SECRET: ${{ secrets.QUY_TS_CLIENT_SECRET }}
      PROTON_PRIVATE_KEY: ${{ secrets.PROTON_PRIVATE_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Tailscale
        uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ secrets.QUY_TS_CLIENT_ID }}
          oauth-secret: ${{ secrets.QUY_TS_CLIENT_SECRET }}
          tags: tag:github
          hostname: proton-gh
          args: --force-reauth

      - name: Run Docker compose
        run: |
          docker compose -f proton.yml up -d

      - name: Delete old workflow runs
        uses: MajorScruffy/delete-old-workflow-runs@v0.3.0
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        with:
          repository: ${{ github.repository }}
          older-than-seconds: 3600

      - name: Do your work
        run: |
          echo "Running job at $(date)"
          sleep 5.8h
      - name: Trigger next run
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GH_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type":"deploy-job"}'
      
